let transactions = JSON.parse(localStorage.getItem('finguard_data')) || [];
let myChart;
let editIndex = -1;

const CATEGORY_COLORS = {
    'Food': '#6366f1',      // indigo-500
    'Transport': '#8b5cf6', // violet-500
    'Bills': '#ec4899',     // pink-500
    'Shopping': '#f43f5e',  // rose-500
    'Groceries': '#10b981', // emerald-500
    'Health': '#06b6d4',    // cyan-500
    'Education': '#f59e0b', // amber-500
    'Entertainment': '#fb7185', // rose-400
    'Travel': '#3b82f6',    // blue-500
    'Personal': '#a855f7',  // purple-500
    'Misc': '#64748b'       // slate-500
};

// Chart.js Center Text Plugin
const centerTextPlugin = {
    id: 'centerText',
    beforeDraw: (chart) => {
        const { ctx, chartArea: { width, height } } = chart;
        ctx.save();
        ctx.font = 'bold 1.5rem Outfit';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#1e293b';
        const total = transactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        ctx.fillText(`PKR ${total.toLocaleString()}`, width / 2, height / 2 + 5);
        ctx.restore();
    }
};

function initChart() {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const data = getCategoryData();

    myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data),
            datasets: [{
                data: Object.values(data),
                backgroundColor: Object.keys(data).map(cat => CATEGORY_COLORS[cat] || '#cbd5e1'),
                borderWidth: 0,
                hoverOffset: 20
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '80%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleFont: { family: 'Outfit', size: 14, weight: 'bold' },
                    bodyFont: { family: 'Outfit', size: 13 },
                    padding: 12,
                    cornerRadius: 12,
                    displayColors: true
                }
            }
        },
        plugins: [centerTextPlugin]
    });
}

function getCategoryData() {
    let totals = {};
    transactions.forEach(t => {
        if (!totals[t.category]) totals[t.category] = 0;
        totals[t.category] += parseFloat(t.amount || 0);
    });
    return totals;
}

function addEntry() {
    const desc = document.getElementById('desc').value;
    const amount = document.getElementById('amount').value;
    const category = document.getElementById('category').value;
    const btn = document.getElementById('submitBtn');

    if (!desc || !amount) return alert("Please fill all fields");

    if (editIndex > -1) {
        transactions[editIndex] = { ...transactions[editIndex], desc, amount, category };
        editIndex = -1;
        btn.innerText = "Authorize Transaction";
        btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        document.getElementById('entryPanel').classList.remove('edit-mode');
    } else {
        transactions.push({ desc, amount, category, date: new Date().toLocaleDateString() });
    }

    localStorage.setItem('finguard_data', JSON.stringify(transactions));
    updateUI();
    document.getElementById('desc').value = "";
    document.getElementById('amount').value = "";
}

function deleteTransaction(index) {
    if (confirm("Are you sure you want to remove this data point?")) {
        transactions.splice(index, 1);
        localStorage.setItem('finguard_data', JSON.stringify(transactions));
        updateUI();
    }
}

function editTransaction(index) {
    const t = transactions[index];
    document.getElementById('desc').value = t.desc;
    document.getElementById('amount').value = t.amount;
    document.getElementById('category').value = t.category;

    editIndex = index;
    const btn = document.getElementById('submitBtn');
    btn.innerText = "Update Entry";
    btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');

    document.getElementById('entryPanel').classList.add('edit-mode');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateUI() {
    const list = document.getElementById('transactionList');
    const totalSpentEl = document.getElementById('totalSpent');
    const transCountEl = document.getElementById('transactionCount');
    const topCatEl = document.getElementById('topCategory');
    const itemCountEl = document.getElementById('itemCount');

    const total = transactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
    const catData = getCategoryData();
    const topCat = Object.keys(catData).reduce((a, b) => catData[a] > catData[b] ? a : b, "None");

    totalSpentEl.innerText = `PKR ${total.toLocaleString()}`;
    transCountEl.innerText = `${transactions.length}`;
    topCatEl.innerText = topCat;
    itemCountEl.innerText = `${transactions.length} Items`;

    list.innerHTML = transactions.map((t, index) => `
        <li class="t-item bg-white/40 p-5 rounded-2xl border border-white/60 flex items-center justify-between group hover:bg-white/80 transition-all">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold" style="background: ${CATEGORY_COLORS[t.category] || '#64748b'}">
                    ${t.category.charAt(0)}
                </div>
                <div>
                    <span class="block font-bold text-slate-800">${t.desc}</span>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] font-extrabold uppercase text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md">${t.category}</span>
                        <span class="text-[10px] font-bold text-slate-300">${t.date}</span>
                    </div>
                </div>
            </div>
            <div class="text-right flex items-center gap-6">
                <span class="font-extrabold text-slate-800">PKR ${parseFloat(t.amount).toLocaleString()}</span>
                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-all">
                    <button onclick="editTransaction(${index})" class="p-2 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-indigo-600 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </button>
                    <button onclick="deleteTransaction(${index})" class="p-2 hover:bg-red-50 rounded-lg text-slate-400 hover:text-red-500 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </li>
    `).reverse().join('');

    if (myChart) {
        myChart.data.labels = Object.keys(catData);
        myChart.data.datasets[0].data = Object.values(catData);
        myChart.data.datasets[0].backgroundColor = Object.keys(catData).map(cat => CATEGORY_COLORS[cat] || '#cbd5e1');
        myChart.update();
    }
}

window.onload = () => {
    initChart();
    updateUI();
};